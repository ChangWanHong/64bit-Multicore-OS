# 64비트 프로세서의 이모저모

## Index
 - 운영모드
 - 운영모드와 레지스터
 - 운영모드와 메모리 관리기법

## 운영모드
인텔 64비트 호환 프로세서(이하 x86-64 프로세서)에서는 크게 다섯가지 운영모드가 있다.
우릭에게 친숙하 16비트의 리얼 모드, 32비트 보호 모드, 64비트의 IA-32e 모드, 시스템 관리 모드, 가상 8086 모드가 있다.
각 모드는 컨트롤 레지스터와 인터럽트라는 특수한 이벤트를 통해 각 모드로 전환할 수 있다.

| 운영 모드 | 설명 |
| :-------: | :--- |
| 리얼 모드 | 프로세서의 초기 상태로서 16비트 모드로 동작<br/>최대 1MB의 주소 공간 지원 |
| 보호 모드 | 32비트 모드로 동작하며 세그먼트, 페이징, 보호, 멀티태스킹 등의 기능 제공<br/>4GB 주소 공간 지원 |
| IA-32e 모드 | 32비트 호환 모드와 64비트 모드의 두 가지 서브모드로 구성<br/>16EB의 주소 공간 지원 |
| 시스템 관리 모드 | 전원 관리나 하드웨어 제어 같은 특수 가능을 제공하는 모드 |
| 가상 8086 모드 | 보호 모드 내부에서 가상의 환경을 설정하여 리얼 모드처럼 동작하는 모드 |

x86-64 프로세서는 위와 같이 총 다섯 가지 운영 모드 지원하지만, 위 운영 모드를 모두 구현해야 OS를 개발할 수 있는건 아니다.
64 비트 OS가 반드시 지원해야 하는 모드는 **리얼모드**, **보호 모드**, **IA-32e모드 중 64비트 서브모드**이다.
나머지 다른 모드는 특수한 상황에서만 사용되므로 반드시 구현할 필요는 없다.

### 리얼 모드
프로세서가 전원이 켜지거나 리셋되면 가장 먼저 리얼모드로 진입한다.
리얼모드는 과거의 16비트 프로세서와 동일하게 동작하며, 이후에 설명할 BIOS(Basic Input Output System)의 여러 기능을 사용할 수 있다.
리얼 모드는 디바이스 드라이버를 제작하지 않아도 되는 장점이 있고, 하는 작업도 OS 이미지를 디스크에서 메모리로 복사하여 보호 모드로 변경하는 것 밖에 없지만, 대부분 작업을 어셈블리어로 처리해야 한다는 단점이 있다.

### 보호 모드
보호 모드는 IA-32e 모드로 전환하려면 공식적으로 거쳐야 하는 모드로, 32비트 윈도우나 리눅스 OS가 동작하는 기본 모드입니다.
최대 4GB의 주소 공간을 제공하며 OS의 필수 기능으로 자리 잡은 보호, 멀티태스킹, 세그먼테이션, 페이징 등의 기능을 하드웨어적으로 지원한다.
여러 기능을 제공하는 만큼 복잡하고, 레지스터와 자료구조가 다양하다.

### IA-32e 모드
IA-32e 모드에는 서브모드로 32비트 호환 모드와 64비트 모드가 있다.
32비트 호환 모드는 보호 모드와 같은 기능을 수행하므로 64비트 모드를 위주로 살펴보겠다.
IA-32e 모드는 최대 16EBd의 주소 공간을 제공하며 레지스터 수도 보호 모드보다 많다.
다만 자료 구조는 더 복잡하지 않고 대부분 보호 모드와 같거나 크지만 2배로 확장되고 일부 필드의 의미가 변하는 정도이므로 보호 모드와 큰 차이는 없다.
한가지 재미있는 사실은 프로세서가 32비트 호환 모드일 때는 보호모드에 있는 것처럼 동작하므로 32비트 코드를 그대로 실행할 수 있다는 점이다.
64비트 OS에서 32비트 보호 모드 코드를 별다른 처리 없이 그대로 실행할 수 있는 것도 이러한 서브모드를 사용하기 때문이다.

### 운영 모드 사이의 관계와 운영 모드의 전환
특정 모드에서 다른 모드로 전환하는 작업은 현재 동작 중인 모드에 따랄 차이가 있다.
리얼 모드에서 보호 모드로 전환하는 상황처럼 다른 모드를 거치지 않고 바로 전환 가능한 경우도 있지만 리얼모드에서 IA-32e모드로 전환하는 상황과 같이 리얼모드 -> 보호모드 -> IA-32 모드를 거쳐서 전환해야 하는 경우도 있다.

![](https://github.com/HIPERCUBE/64bit-Multicore-OS/blob/master/book/img/Ch3_img1.png)

위 그림의 화살표 위에 표시된 내용은 해당 모드로 전환하는데 필요한 조건을 나타낸 것이다.
조건에는 컨트롤 레지스터와 인터럽트 발생만 표시되어 있지만, 기본적으로 각 모드에 필요한 자료구조는 미리 설정되어 있어야 한다.
화살표가 연결되지 않은 리얼모드에서 IA-32e 모드로 전환하는 것은 불가능하며, 무리하게 시도하면 리셋이나 예외가 발생할 수 있다.
(실제 편법을 사용하면 가능하긴 하지만 여기서는 다루지 않는다.)


## 운영 모드와 레지스터
OS를 개발하는 관점에서 운용 모드는 크게 16비트 모드, 32비트 모드, 64비트 모드 세 가지로 나눌 수 있다.
운영 모드 앞에 붙은 숫자는 레지스터의 크기와 관계가 있으며 숫자가 커질수록 레지스터의 개수도 많아진다.


![보호모드에서의 레지스터]()

![IA-32e모드에서의 레지스터]()

x86-64 프로세서에는 위 그림들과 같이 많은 레지스터가 있지만, OS를 개발하는 과정에서 큰 비중을 차지하는 범용 레지스터, 세그먼트 레지스터, 컨트롤 레지스터 세 가지이다.
